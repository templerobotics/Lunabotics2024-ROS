#!/bin/bash

set -xe

echo "STARTING ROBOT TELEOPERATION CONTROL!"

ros2 launch robot_launch teleop.launch.py &

echo "STARTING ROBOT CAMERA LIVESTREAM FOOTAGE!"

# 1080p Clear Video w/ slight noticeable delay
ffmpeg -f v4l2 -framerate 30 -video_size 1920x1080 -i /dev/video0 \
  -c:v libx264 -preset ultrafast -tune zerolatency \
  -f matroska pipe:1 | \
ffplay -fflags nobuffer -framedrop -i - &


# Extreme low-latency settings - 720P
ffmpeg -f v4l2 -framerate 30 -video_size 1280x720 -i /dev/video0 \
  -c:v libx264 -preset ultrafast -tune zerolatency \
  -x264-params "nal-hrd=cbr:force-cfr=1" \
  -b:v 750k -minrate 750k -maxrate 750k -bufsize 150k \
  -an -sn -f mpegts pipe:1 | \
ffplay -fflags nobuffer -framedrop -flags low_delay \
  -probesize 32 -analyzeduration 0 -sync ext \
  -i - &


wait
